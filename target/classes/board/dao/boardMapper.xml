<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="boardSQL">
	<!-- 글쓰기  -->
	
	<insert id="qaWrite" parameterType="java.util.Map" >
		INSERT into BOARD_QA values(
				board_seq.nextval
			  ,#{productid}
			  ,#{user_id}
			  ,#{qa_pwd}
			  ,#{qa_subject}
			  ,#{qa_content}
			  ,#{qa_state}
			  ,0
			  ,SYSDATE)
	</insert>
	<insert id="reviewWrite" parameterType="review">
		insert into BOARD_REVIEW values(
			  board_seq.nextval
			  ,#{productid}
			  ,#{user_id}
			  ,#{review_pwd}
			  ,#{review_subject}
			  ,#{review_content}
			  ,board_seq.currval
			  ,0
			  ,0
			  ,0
			  ,0
			  ,0
			  ,SYSDATE)
	</insert>	
	
	<!-- 목록 -->
	<select id="qaList" parameterType="java.util.Map" resultType="qa">
		select * from 
		(select rownum rn, tt.* from 
		(select qa.*,m.name from board_qa qa,member m 
		where qa.user_id=m.id 
		order by qa_logtime desc)
		 tt) 
		where (rn between #{startNum} and #{endNum}) 
	</select>

	<select id="reviewList" parameterType="java.util.Map" resultType="review">
		select * from 
		(select rownum rn, tt.* from 
		(select r.*,m.name from BOARD_REVIEW r,member m 
		where r.user_id=m.id 
		order by review_ref desc, review_step asc)
		 tt) 
		where (rn between #{startNum} and #{endNum}) 
	</select>	
	
	<!-- 총글수 -->
	<select id="getTotalA" parameterType="java.util.Map" resultType="Integer">
  		select count(*) from ${tableName} 
 	</select>

 	<!-- 검색 -->
 	<select id="qaSearch" parameterType="java.util.Map" resultType="qa">
		 		select * from 
				(select rownum rn, tt.* from 
				(select * from board_qa
				inner join member 
				on board_qa.user_id = member.id
				where ${searchOption} like '%'||#{keyword}||'%'
				order by qa_logtime desc) tt) 
				where (rn between #{startNum} and #{endNum})
 	</select>
  	<select id="reviewSearch" parameterType="java.util.Map" resultType="review">
			    select * from 
				(select rownum rn, tt.* from 
				(select * from board_review
				inner join member 
				on board_review.user_id = member.id				
				where ${searchOption} like '%'||#{keyword}||'%'
				order by review_ref desc, review_step asc) tt) 
				where (rn between #{startNum} and #{endNum})
 	</select>
 		
 	<!-- 검색 : 총글수 -->
 	<select id="getTotalSearchA" parameterType="java.util.Map" resultType="int">
 		select count(*) from ${tableName}
 		inner join member 
		on ${tableName}.user_id = member.id			 
 		where ${searchOption} like '%'||#{keyword}||'%'
 	</select>
 	 	
 	<!--글 가져오기 -->
 	<select id="getQaBoard" parameterType="String" resultType="qa">
  		select * from board_qa
  		inner join member 
		on board_qa.user_id = member.id
		where qa_seq=#{qa_seq}
 	</select>
  	<select id="getReviewBoard" parameterType="String" resultType="review">
  		select * from board_review
  		inner join member 
		on review_seq.user_id = member.id
		where review_seq=#{review_seq}
 	</select>	
 	<!-- 관리자 답변 가져오기 -->
 	<select id="getQaAns" parameterType="String" resultType="adminBoard">
 		select * from board_admin where admin_pseq=#{seq}
 	</select>
 	<!-- 글 수정 하기 -->
 	<update id="qaModify" parameterType="java.util.Map">
		update board_qa set qa_subject=#{qa_subject}
							,qa_content=#{qa_content}
							,productid=#{productid}
							,qa_state=#{qa_state}
							,qa_logtime=sysdate 
							where qa_seq=#{qa_seq}														
 	</update>
 	<!-- 관리자 문의 총글수 -->
	<select id="getAdminQATotalA" resultType="Integer">
  		select count(*) from BOARD_QA where qa_reply=0 
 	</select> 	
 	<!-- 관리자 문의 리스트 -->
 	<select id="qaManageList" parameterType="java.util.Map" resultType="qa">
		select * from 
		(select rownum rn, tt.* from 
		(select qa.*,m.name from BOARD_QA qa,MEMBER m 
		where qa.user_id=m.id and qa_reply=0
		order by qa_logtime desc)
		 tt) 
		where (rn between #{startNum} and #{endNum})
 	</select>
 	<!-- 관리자 답변 작성 -->
 	<insert id="qaManageWrite" parameterType="java.util.Map">
 		begin
 		
 		insert into board_admin values(admin_seq.nextval,#{admin_pseq},#{user_id},#{admin_content});
 		
 		update board_qa set  qa_reply=1 where qa_seq=#{admin_pseq};
 		
 		end;
 	</insert>
 <!--
 	글수정
 	<update id="boardModify" parameterType="java.util.Map">
		update board set subject=#{subject}
						,content=#{content}
						,logtime=sysdate where seq=#{seq}
	</update>

	 답글 
	<update id="boardReply1" parameterType="review">
  		update board set step=step+1 where ref=#{ref} and step>#{step}
 	</update>
 	
 	<insert id="boardReply2" parameterType="java.util.Map">
		insert into board values(seq_board.nextval
							 	,#{id}
							 	,#{name}
							 	,#{email}
							 	,#{subject}
							 	,#{content}
							 	,#{ref}
							 	,#{lev}
							 	,#{step}
							 	,#{pseq}
							 	,0
							 	,0
							 	,sysdate)
 	</insert>
 	
 	<update id="boardReply3" parameterType="Integer">
 		update board set reply=reply+1 where seq=#{seq}
	</update>
	
	조회수 
	<update id="hitUpdate" parameterType="Integer">
		update board set hit=hit+1 where seq=#{seq}
	</update>
 	
 	 글삭제 
 	<delete id="boardDelete" parameterType="Integer">
 		begin
 			update board set reply=reply-1 
 			where seq=(select pseq from board where seq=#{seq});
 			
 			update board set subject='[원글이 삭제된 답글] '||subject where pseq=#{seq};
 			
 			delete board where seq=#{seq};
 		end;
 	</delete>
 	-->

</mapper>















